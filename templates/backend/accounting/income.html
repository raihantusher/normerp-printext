{% extends 'backend/dashboard_base.html' %}

{% block content %}
<main>
    <div class="container-fluid px-4">
        <h1 class="mt-4">Customers</h1>
        <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item">Dashboard</li>
            <li class="breadcrumb-item active">Customers</li>
        </ol>
        <div class="row">
            <div class="col-xl-3 col-md-6">
                <div class="card bg-primary text-white mb-4">
                    <div class="card-body">Primary Card</div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href="#">View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-warning text-white mb-4">
                    <div class="card-body">Warning Card</div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href="#">View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-success text-white mb-4">
                    <div class="card-body">Success Card</div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href="#">View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-danger text-white mb-4">
                    <div class="card-body">Danger Card</div>
                    <div class="card-footer d-flex align-items-center justify-content-between">
                        <a class="small text-white stretched-link" href="#">View Details</a>
                        <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Customer Payment Form</h3>
                    </div>
                    <div class="card-body">
                        <form id="income-entry-form">
                            <!-- Customer Selection -->
                            <div class="mb-4">
                                <label for="customerSelect" class="form-label fw-bold">Select Customer</label>
                                <select class="form-select" id="customerSelect" required>
                                    <option value="" selected disabled>Choose customer...</option>
                                </select>
                                <div class="form-text">Can't find the customer? <a href="#">Add new customer</a></div>
                            </div>

                            <!-- Debit Account -->
                            <div class="mb-4">
                                <label for="debitAccount" class="form-label fw-bold">Debit Account</label>
                                <select class="form-select" id="debitAccount" required>
                                    <option value="" selected disabled>Select account to debit...</option>
                                </select>
                            </div>

                            <!-- Payment Amount -->
                            <div class="mb-4">
                                <label for="paymentAmount" class="form-label fw-bold">Payment Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="paymentAmount" placeholder="0.00"
                                           step="0.01" min="0" required>
                                </div>
                            </div>

                            <!-- Payment Date -->
                            <div class="mb-4">
                                <label for="paymentDate" class="form-label fw-bold">Payment Date</label>
                                <input type="datetime-local" class="form-control" id="paymentDate" required>
                            </div>

                            <!-- Payment Reference -->
                            <div class="mb-4">
                                <label for="paymentReference" class="form-label fw-bold">Payment Reference</label>
                                <input type="text" class="form-control" id="paymentReference"
                                       placeholder="Invoice #, Receipt #, etc.">
                            </div>


                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="reset" class="btn btn-outline-secondary me-md-2">Clear Form</button>
                                <button type="submit" class="btn btn-primary">Process Payment</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>


<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">New message</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="customerForm" method="post">
                <div class="modal-body">

                    <div class="mb-3">
                        <label for="customer_name" class="col-form-label">Company Name:</label>
                        <input type="text" class="form-control" id="customer_name">
                    </div>
                    <div class="mb-3">
                        <label for="customer_name" class="col-form-label">Owner Name:</label>
                        <input type="text" class="form-control" id="owner_name">
                    </div>
                    <div class="mb-3">
                        <label for="customer_name" class="col-form-label">Price:</label>
                        <input type="text" class="form-control" id="price_per_meter">
                    </div>
                    <div class="mb-3">
                        <label for="customer_name" class="col-form-label">Remarks:</label>
                        <input type="text" class="form-control" id="remarks">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Send message</button>
                    <input type="submit" value="Send Request" class="btn btn-primary"/>

                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}

{{ block.super }}

<script>
    $(document).ready(function() {


        /*
        * make add customer form empty after submission
        */
        function makeEmptyForm() {
                $('#customer_name').val('');
                $('#owner_name').val('');
                $('#price_per_meter').val(0);
                $('#remarks').val('');
        }

        $.ajax({
              type: 'GET',
              url: '/api/customers/',
              success: function(response) {
                console.log( response);

                // get request
                // process and display data into table
                displayCustomerData(response)
              },
              error: function(xhr, status, error) {
                console.error('Error:', error);
                //$('#error-message').text('Failed to load data: ' + error).show();
              }
            });


            function displayCustomerData(data) {
                // Example: Display data in a table or list
                var $container = $('#customerSelect');
                //$container.empty(); // Clear previous data

                if (Array.isArray(data)) {
                  $.each(data, function(index, item) {
                    $container.append(`<option class="item" value="${item.id}">  ${item.customer_name}  </option>`);
                    //$container.append('<option value="${item.id}>${item.customer_name}</option>');
                  });
                } else {
                  $container.append('<div>' + JSON.stringify(data) + '</div>');
                }
              }




            $.ajax({
              type: 'GET',
              url: '/api/cash-bank/',
              success: function(response) {
                console.log( response);

                // get request
                // process and display data into table
                displayCashBankData(response)
              },
              error: function(xhr, status, error) {
                console.error('Error:', error);
                //$('#error-message').text('Failed to load data: ' + error).show();
              }
            });


            function displayCashBankData(data) {
                // Example: Display data in a table or list
                var $container = $('#debitAccount');
                //$container.empty(); // Clear previous data

                if (Array.isArray(data)) {
                  $.each(data, function(index, item) {
                    $container.append(`<option class="item" value="${item.id}">  ${item.name} - ${item.get_balance.balance}  </option>`);
                    //$container.append('<option value="${item.id}>${item.customer_name}</option>');
                  });
                } else {
                  //$container.append('<div>' + JSON.stringify(data) + '</div>');
                }
              }


              /****
              *
              *  Post customer payment as income
              *
              */
              $('#income-entry-form').submit(function(e) {
                    e.preventDefault(); // Prevent default form submission

                    //var formData = $(this).serialize(); // Serializes all form fields
                    // Get form data
                    var formData = {
                      customer: $('#customerSelect').val(),
                      account: $('#debitAccount').val(),
                      amount: $('#paymentAmount').val(),
                      date: $('#paymentDate').val(),
                    };
                    console.log(formData)

                    // Send POST request
                    $.ajax({
                      type: 'POST',
                      url: '/api/payment-list/',
                      // headers: {
                         //   'Authorization': 'Bearer ' + token,
                          //  'X-Custom-Header': 'value'
                       //},
                      data: formData,
                      //data: JSON.stringify(formData),
                      success: function(response) {
                        console.log('Success:', response);
                          //makeEmptyForm();
                          // $('#customerModal').modal('hide');
                        // Handle success (e.g., show success message)
                        //$('#success-message').show();
                      },
                      error: function(xhr, status, error) {
                        console.error('Error:', error);
                        // Handle error (e.g., show error message)
                        //$('#error-message').text('An error occurred: ' + error).show();
                      }
                    });
                  });


    });
</script>
{% endblock %}